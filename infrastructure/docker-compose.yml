services:
  backend:
    build:
      context: ../
      dockerfile: apps/backend/Dockerfile
      target: installer
    ports:
      - "5114:5114"
    environment:
      - NODE_ENV=development
      - PORT=5114
      - DATABASE_URL=postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}@postgres:5432/${POSTGRES_DB:-ai_trader}
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - CONTROL_PLANE_TOKEN=${CONTROL_PLANE_TOKEN}
      - READ_API_TOKEN=${READ_API_TOKEN:-}
      - LIVE_ORDER_POSTING_ENABLED=${LIVE_ORDER_POSTING_ENABLED:-false}
      - PRIVATE_KEY=${PRIVATE_KEY:-}
      - POLY_PRIVATE_KEY=${POLY_PRIVATE_KEY:-}
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS:-}
      - POLY_FUNDER_ADDRESS=${POLY_FUNDER_ADDRESS:-}
      - POLY_RPC_URL=${POLY_RPC_URL:-}
      - POLY_AUTO_REDEEM_ENABLED=${POLY_AUTO_REDEEM_ENABLED:-false}
      - POLY_SETTLEMENT_POLL_MS=${POLY_SETTLEMENT_POLL_MS:-30000}
      - POLY_REDEEM_RETRY_COOLDOWN_MS=${POLY_REDEEM_RETRY_COOLDOWN_MS:-60000}
      - POLY_MIN_REDEEMABLE_SHARES=${POLY_MIN_REDEEMABLE_SHARES:-0.01}
      - POLY_SETTLEMENT_STALE_MS=${POLY_SETTLEMENT_STALE_MS:-3600000}
      - POLY_COLLATERAL_TOKEN_ADDRESS=${POLY_COLLATERAL_TOKEN_ADDRESS:-}
      - POLY_CONDITIONAL_TOKENS_ADDRESS=${POLY_CONDITIONAL_TOKENS_ADDRESS:-}
      - INTELLIGENCE_GATE_ENABLED=${INTELLIGENCE_GATE_ENABLED:-true}
      - INTELLIGENCE_GATE_MAX_STALENESS_MS=${INTELLIGENCE_GATE_MAX_STALENESS_MS:-3000}
      - INTELLIGENCE_GATE_MIN_MARGIN=${INTELLIGENCE_GATE_MIN_MARGIN:-0}
      - ENABLE_XRP_STRATEGIES=${ENABLE_XRP_STRATEGIES:-false}
      - ENABLE_ONE_MINUTE_STRATEGIES=${ENABLE_ONE_MINUTE_STRATEGIES:-false}
      - FEATURE_DATASET_MANIFEST_PATH=/app/reports/feature_dataset_manifest.json
      - SIGNAL_MODEL_REPORT_PATH=/app/reports/models/signal_model_report.json
      - SIGNAL_MODEL_ARTIFACT_PATH=/app/reports/models/signal_model_latest.json
      - DEFAULT_DISABLED_STRATEGIES=
      - STRATEGY_WEIGHT_CAP=${STRATEGY_WEIGHT_CAP:-2.0}
      - STRATEGY_ALLOCATOR_EMA_ALPHA=0.05
      - RISK_GUARD_STRATEGIES=BTC_1M,BTC_5M,BTC_15M,ETH_1M,ETH_5M,ETH_15M,SOL_1M,SOL_5M,SOL_15M,XRP_1M,XRP_5M,XRP_15M,CEX_SNIPER,OBI_SCALPER,SYNDICATE,ATOMIC_ARB,GRAPH_ARB,CONVERGENCE_CARRY,MAKER_MM,AS_MARKET_MAKER,LONGSHOT_BIAS
      - VAULT_ENABLED=true
      - VAULT_BANKROLL_CEILING=1100
      - RISK_GUARD_TRAILING_STOP=100
      - RISK_GUARD_DAILY_TARGET=300
      - RISK_GUARD_DAY_RESET_HOUR_UTC=8
      - RISK_GUARD_CONSEC_LOSS_LIMIT=4
      - RISK_GUARD_CONSEC_LOSS_COOLDOWN_MS=1800000
      - RISK_GUARD_POST_LOSS_COOLDOWN_MS=300000
      - RISK_GUARD_ANTI_MARTINGALE_AFTER=2
      - RISK_GUARD_ANTI_MARTINGALE_FACTOR=0.5
      - RISK_GUARD_DIRECTION_LIMIT=3
      - RISK_GUARD_PROFIT_TAPER_START=200
      - RISK_GUARD_PROFIT_TAPER_FLOOR=0.5
    env_file:
      - ../apps/backend/.env
    depends_on:
      - postgres
      - redis
    volumes:
      - ../apps/backend:/app/apps/backend
      - ../packages:/app/packages
      - ../reports:/app/reports
    command: npm run dev --workspace=@ai-trader/backend
    init: true
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -q -T 6 -t 1 -O- http://localhost:5114/health >/dev/null && touch /tmp/backend_healthy_once && rm -f /tmp/backend_hc_failures && exit 0; if [ -f /tmp/backend_healthy_once ]; then n=$$(cat /tmp/backend_hc_failures 2>/dev/null || echo 0); n=$$((n+1)); echo \"$$n\" >/tmp/backend_hc_failures; [ \"$$n\" -ge 8 ] && kill -s TERM 1; fi; exit 1",
        ]
      interval: 20s
      timeout: 8s
      retries: 5
      start_period: 45s
    mem_limit: 2g

  frontend:
    build:
      context: ../
      dockerfile: apps/frontend/Dockerfile
      target: installer
    ports:
      - "3112:3112"
    environment:
      - VITE_API_URL=http://100.83.153.43:5114
    volumes:
      - ../apps/frontend:/app/apps/frontend
      - ../packages:/app/packages
    command: npm run dev --workspace=@ai-trader/frontend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3112 || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      POSTGRES_DB: ${POSTGRES_DB:-ai_trader}
    ports:
      - "127.0.0.1:5544:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:?REDIS_PASSWORD must be set}
    command: /bin/sh -c "redis-server --appendonly yes --appendfsync always --save 900 1 --save 300 10 --requirepass \"$$REDIS_PASSWORD\""
    ports:
      - "127.0.0.1:6491:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    mem_limit: 1g
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a \"$$REDIS_PASSWORD\" ping | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis-backup:
    profiles: ["ops"]
    image: alpine:3.20
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - REDIS_BACKUP_DIR=/backups
      - REDIS_BACKUP_INTERVAL_SEC=${REDIS_BACKUP_INTERVAL_SEC:-300}
      - REDIS_BACKUP_KEEP=${REDIS_BACKUP_KEEP:-288}
      - REDIS_BACKUP_S3_URI=${REDIS_BACKUP_S3_URI:-}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ../scripts/redis_backup.sh:/usr/local/bin/redis_backup.sh:ro
      - ../scripts/redis_backup_loop.sh:/usr/local/bin/redis_backup_loop.sh:ro
      - ../backups/redis:/backups
    command: >
      /bin/sh -c
      "apk add --no-cache bash redis aws-cli >/dev/null
      && /usr/local/bin/redis_backup_loop.sh"
    restart: unless-stopped
    mem_limit: 256m

  postgres-backup:
    profiles: ["ops"]
    image: alpine:3.20
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      - POSTGRES_DB=${POSTGRES_DB:-ai_trader}
      - POSTGRES_BACKUP_DIR=/backups
      - POSTGRES_BACKUP_INTERVAL_SEC=${POSTGRES_BACKUP_INTERVAL_SEC:-900}
      - POSTGRES_BACKUP_KEEP=${POSTGRES_BACKUP_KEEP:-168}
      - POSTGRES_BACKUP_S3_URI=${POSTGRES_BACKUP_S3_URI:-}
      - POSTGRES_BACKUP_S3_RETRIES=${POSTGRES_BACKUP_S3_RETRIES:-3}
      - POSTGRES_BACKUP_S3_RETRY_DELAY_SEC=${POSTGRES_BACKUP_S3_RETRY_DELAY_SEC:-3}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ../scripts/postgres_backup.sh:/usr/local/bin/postgres_backup.sh:ro
      - ../scripts/postgres_backup_loop.sh:/usr/local/bin/postgres_backup_loop.sh:ro
      - ../backups/postgres:/backups
    command: >
      /bin/sh -c
      "apk add --no-cache bash postgresql-client aws-cli >/dev/null
      && /usr/local/bin/postgres_backup_loop.sh"
    restart: unless-stopped
    mem_limit: 256m

  ml-service:
    build:
      context: ../apps/ml-service
      dockerfile: Dockerfile
    ports:
      - "8112:8112"
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
    depends_on:
      - redis
    volumes:
      - ../apps/ml-service:/app
    command: uvicorn src.main:app --host 0.0.0.0 --port 8112 --reload
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8112/health')\" || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
    mem_limit: 512m

  # ── Shared Rust builder ────────────────────────────────────────────
  # Compiles the arb-scanner binary ONCE. All 13 strategy containers
  # share the build artifacts via the arb_target named volume.
  arb-builder:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    user: "0:0"
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: cargo build
    mem_limit: 4g
    # No restart — runs once, exits 0, scanners start

  # ── Swarm Strategy Containers ──────────────────────────────────────
  # Each scanner runs the pre-built binary directly (no recompilation).
  # STRATEGY_TYPE env var selects which strategy logic to execute.

  arb-scanner-btc:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=BTC_15M
      - STRATEGY_VARIANT=baseline
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - SIM_FEE_BPS_PER_SIDE=0
      - SIM_SLIPPAGE_BPS_PER_SIDE=2
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-btc-5m:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=BTC_5M
      - STRATEGY_VARIANT=baseline
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - SIM_FEE_BPS_PER_SIDE=0
      - SIM_SLIPPAGE_BPS_PER_SIDE=2
      - BTC_5M_MIN_EXPECTED_NET_RETURN=0.008
      - BTC_5M_MAX_POSITION_FRACTION=0.10
      - BTC_5M_MAX_ENTRY_SPREAD=0.05
      - BTC_5M_NOTIONAL_CAP=35
      - BTC_5M_FAIR_PRICE_EXTRA_BPS=100
      - BTC_5M_FAIR_PRICE_BAND=0.03
      - BTC_5M_MOMENTUM_FILTER_ENABLED=true
      - BTC_5M_MOMENTUM_RSI_HIGH=72
      - BTC_5M_MOMENTUM_RSI_LOW=28
      - BTC_5M_MOMENTUM_PENALTY_BPS=80
      - BTC_5M_REGIME_FILTER_ENABLED=true
      - BTC_5M_REGIME_CHOP_PENALTY_BPS=50
      - BTC_5M_SPREAD_QUALITY_PENALTY_BPS=60
      - BTC_5M_COINFLIP_BLOCK_BAND=0.03
      - BTC_5M_KELLY_SCALE_FLOOR=0.20
      - BTC_5M_EDGE_SCALE_TARGET_RATIO=1.25
      - BTC_5M_EDGE_SCALE_FLOOR=0.40
      - BTC_5M_FEE_CURVE_BASE_RATE=0.02
      - BTC_5M_MAX_SPOT_AGE_MS=1200
      - BTC_5M_MAX_BOOK_AGE_MS=900
      - BTC_5M_LIVE_PREVIEW_COOLDOWN_MS=900
      - BTC_5M_IV_BLEND_WEIGHT=0.65
      - BTC_5M_IV_MAX_STALE_MS=90000
      - BTC_5M_DIVERGENCE_MIN_FLOOR=0.03
      - BTC_5M_DIVERGENCE_SPREAD_MULT=0.40
      - BTC_5M_DIVERGENCE_VOL_MULT=0.30
      - BTC_5M_DIVERGENCE_UNCERTAINTY_BPS=12
      - DERIBIT_IV_REFRESH_MS=10000
      - DERIBIT_IV_HTTP_TIMEOUT_MS=4000
      - DERIBIT_IV_MAX_SPOT_AGE_MS=15000
      - DERIBIT_IV_MIN_SAMPLES=4
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-eth:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=ETH_15M
      - STRATEGY_VARIANT=baseline
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - ETH_15M_MAX_SPOT_AGE_MS=2200
      - ETH_15M_MAX_BOOK_AGE_MS=1500
      - ETH_15M_LIVE_PREVIEW_COOLDOWN_MS=1500
      - ETH_15M_DECISION_INTERVAL_MS=220
      - ETH_15M_IV_BLEND_WEIGHT=0.55
      - ETH_15M_DIVERGENCE_MIN_FLOOR=0.018
      - ETH_15M_DIVERGENCE_SPREAD_MULT=0.30
      - ETH_15M_DIVERGENCE_VOL_MULT=0.20
      - ETH_15M_DIVERGENCE_UNCERTAINTY_BPS=10
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-eth-5m:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=ETH_5M
      - STRATEGY_VARIANT=baseline
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - SIM_FEE_BPS_PER_SIDE=0
      - SIM_SLIPPAGE_BPS_PER_SIDE=2
      - ETH_5M_MAX_SPOT_AGE_MS=1400
      - ETH_5M_MAX_BOOK_AGE_MS=1000
      - ETH_5M_LIVE_PREVIEW_COOLDOWN_MS=900
      - ETH_5M_DECISION_INTERVAL_MS=150
      - ETH_5M_IV_BLEND_WEIGHT=0.60
      - ETH_5M_DIVERGENCE_MIN_FLOOR=0.025
      - ETH_5M_DIVERGENCE_SPREAD_MULT=0.35
      - ETH_5M_DIVERGENCE_VOL_MULT=0.25
      - ETH_5M_DIVERGENCE_UNCERTAINTY_BPS=12
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-sol:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=SOL_15M
      - STRATEGY_VARIANT=baseline
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - SOL_15M_MAX_SPOT_AGE_MS=2400
      - SOL_15M_MAX_BOOK_AGE_MS=1600
      - SOL_15M_LIVE_PREVIEW_COOLDOWN_MS=1500
      - SOL_15M_DECISION_INTERVAL_MS=220
      - SOL_15M_DIVERGENCE_MIN_FLOOR=0.020
      - SOL_15M_DIVERGENCE_SPREAD_MULT=0.35
      - SOL_15M_DIVERGENCE_VOL_MULT=0.25
      - SOL_15M_DIVERGENCE_UNCERTAINTY_BPS=14
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-sol-5m:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=SOL_5M
      - STRATEGY_VARIANT=baseline
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - SIM_FEE_BPS_PER_SIDE=0
      - SIM_SLIPPAGE_BPS_PER_SIDE=2
      - SOL_5M_MAX_SPOT_AGE_MS=1500
      - SOL_5M_MAX_BOOK_AGE_MS=1000
      - SOL_5M_LIVE_PREVIEW_COOLDOWN_MS=900
      - SOL_5M_DECISION_INTERVAL_MS=150
      - SOL_5M_DIVERGENCE_MIN_FLOOR=0.028
      - SOL_5M_DIVERGENCE_SPREAD_MULT=0.40
      - SOL_5M_DIVERGENCE_VOL_MULT=0.30
      - SOL_5M_DIVERGENCE_UNCERTAINTY_BPS=16
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-xrp:
    profiles: ["experimental"]
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=XRP_15M
      - STRATEGY_VARIANT=baseline
      - ENABLE_XRP_STRATEGIES=true
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - XRP_15M_MAX_SPOT_AGE_MS=2400
      - XRP_15M_MAX_BOOK_AGE_MS=1600
      - XRP_15M_LIVE_PREVIEW_COOLDOWN_MS=1500
      - XRP_15M_DECISION_INTERVAL_MS=220
      - XRP_15M_DIVERGENCE_MIN_FLOOR=0.022
      - XRP_15M_DIVERGENCE_SPREAD_MULT=0.35
      - XRP_15M_DIVERGENCE_VOL_MULT=0.25
      - XRP_15M_DIVERGENCE_UNCERTAINTY_BPS=16
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-xrp-5m:
    profiles: ["experimental"]
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=XRP_5M
      - STRATEGY_VARIANT=baseline
      - ENABLE_XRP_STRATEGIES=true
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - SIM_FEE_BPS_PER_SIDE=0
      - SIM_SLIPPAGE_BPS_PER_SIDE=2
      - XRP_5M_MAX_SPOT_AGE_MS=1600
      - XRP_5M_MAX_BOOK_AGE_MS=1100
      - XRP_5M_LIVE_PREVIEW_COOLDOWN_MS=900
      - XRP_5M_DECISION_INTERVAL_MS=150
      - XRP_5M_DIVERGENCE_MIN_FLOOR=0.030
      - XRP_5M_DIVERGENCE_SPREAD_MULT=0.42
      - XRP_5M_DIVERGENCE_VOL_MULT=0.30
      - XRP_5M_DIVERGENCE_UNCERTAINTY_BPS=18
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-btc-1m:
    profiles: ["experimental"]
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=BTC_1M
      - STRATEGY_VARIANT=baseline
      - ENABLE_ONE_MINUTE_STRATEGIES=true
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - BTC_1M_MAX_SPOT_AGE_MS=900
      - BTC_1M_MAX_BOOK_AGE_MS=700
      - BTC_1M_LIVE_PREVIEW_COOLDOWN_MS=500
      - BTC_1M_DECISION_INTERVAL_MS=100
      - BTC_1M_IV_BLEND_WEIGHT=0.70
      - BTC_1M_DIVERGENCE_MIN_FLOOR=0.050
      - BTC_1M_DIVERGENCE_SPREAD_MULT=0.50
      - BTC_1M_DIVERGENCE_VOL_MULT=0.35
      - BTC_1M_DIVERGENCE_UNCERTAINTY_BPS=20
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-eth-1m:
    profiles: ["experimental"]
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=ETH_1M
      - STRATEGY_VARIANT=baseline
      - ENABLE_ONE_MINUTE_STRATEGIES=true
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - ETH_1M_MAX_SPOT_AGE_MS=950
      - ETH_1M_MAX_BOOK_AGE_MS=700
      - ETH_1M_LIVE_PREVIEW_COOLDOWN_MS=500
      - ETH_1M_DECISION_INTERVAL_MS=100
      - ETH_1M_IV_BLEND_WEIGHT=0.68
      - ETH_1M_DIVERGENCE_MIN_FLOOR=0.048
      - ETH_1M_DIVERGENCE_SPREAD_MULT=0.48
      - ETH_1M_DIVERGENCE_VOL_MULT=0.35
      - ETH_1M_DIVERGENCE_UNCERTAINTY_BPS=20
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-sol-1m:
    profiles: ["experimental"]
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=SOL_1M
      - STRATEGY_VARIANT=baseline
      - ENABLE_ONE_MINUTE_STRATEGIES=true
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - SOL_1M_MAX_SPOT_AGE_MS=1000
      - SOL_1M_MAX_BOOK_AGE_MS=750
      - SOL_1M_LIVE_PREVIEW_COOLDOWN_MS=500
      - SOL_1M_DECISION_INTERVAL_MS=100
      - SOL_1M_DIVERGENCE_MIN_FLOOR=0.055
      - SOL_1M_DIVERGENCE_SPREAD_MULT=0.55
      - SOL_1M_DIVERGENCE_VOL_MULT=0.38
      - SOL_1M_DIVERGENCE_UNCERTAINTY_BPS=24
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-xrp-1m:
    profiles: ["experimental"]
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=XRP_1M
      - STRATEGY_VARIANT=baseline
      - ENABLE_XRP_STRATEGIES=true
      - ENABLE_ONE_MINUTE_STRATEGIES=true
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - XRP_1M_MAX_SPOT_AGE_MS=1000
      - XRP_1M_MAX_BOOK_AGE_MS=750
      - XRP_1M_LIVE_PREVIEW_COOLDOWN_MS=500
      - XRP_1M_DECISION_INTERVAL_MS=100
      - XRP_1M_DIVERGENCE_MIN_FLOOR=0.058
      - XRP_1M_DIVERGENCE_SPREAD_MULT=0.56
      - XRP_1M_DIVERGENCE_VOL_MULT=0.40
      - XRP_1M_DIVERGENCE_UNCERTAINTY_BPS=25
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-cex:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=CEX_ARB
      - STRATEGY_VARIANT=baseline
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-copy:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=COPY_BOT
      - STRATEGY_VARIANT=baseline
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-atomic:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=ATOMIC_ARB
      - STRATEGY_VARIANT=baseline
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - SIM_FEE_BPS_PER_SIDE=0
      - SIM_SLIPPAGE_BPS_PER_SIDE=2
      - ATOMIC_ARB_MIN_NET_EDGE=0.0010
      - ATOMIC_ARB_MIN_BUFFER_FLOOR=0.0020
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-obi:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=OBI_SCALPER
      - STRATEGY_VARIANT=baseline
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-graph:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=GRAPH_ARB
      - STRATEGY_VARIANT=baseline
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - SIM_FEE_BPS_PER_SIDE=0
      - SIM_SLIPPAGE_BPS_PER_SIDE=2
      - GRAPH_ARB_MIN_NET_EDGE=0.0015
      - GRAPH_ARB_MIN_BUFFER_FLOOR=0.0010
      - GRAPH_ARB_HORIZON_PENALTY_COEFF=0.0005
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-convergence:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=CONVERGENCE_CARRY
      - STRATEGY_VARIANT=baseline
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - SIM_FEE_BPS_PER_SIDE=0
      - SIM_SLIPPAGE_BPS_PER_SIDE=2
      - CONVERGENCE_CARRY_MIN_PARITY_EDGE=0.008
      - CONVERGENCE_CARRY_EXIT_PARITY_EDGE=0.002
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-maker:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=MAKER_MM
      - STRATEGY_VARIANT=baseline
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - SIM_FEE_BPS_PER_SIDE=0
      - SIM_SLIPPAGE_BPS_PER_SIDE=2
      - MAKER_MM_MIN_EXPECTED_NET_RETURN=0.001
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-as-mm:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=AS_MARKET_MAKER
      - STRATEGY_VARIANT=baseline
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - SIM_FEE_BPS_PER_SIDE=0
      - SIM_SLIPPAGE_BPS_PER_SIDE=2
      - AS_MM_GAMMA=0.3
      - AS_MM_KAPPA=1.5
      - AS_MM_MIN_HALF_SPREAD=0.015
      - AS_MM_MIN_EDGE_BPS=15
      - AS_MM_FEE_CURVE_BASE_RATE=0.02
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

  arb-scanner-longshot:
    build:
      context: ../apps/arb-scanner
      dockerfile: Dockerfile
      target: dev
    environment:
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD}@redis:6379}
      - RUST_LOG=info
      - STRATEGY_TYPE=LONGSHOT_BIAS
      - STRATEGY_VARIANT=baseline
      - PROXY_WALLET_ADDRESS=${PROXY_WALLET_ADDRESS}
      - SIM_FEE_BPS_PER_SIDE=0
      - SIM_SLIPPAGE_BPS_PER_SIDE=2
      - LONGSHOT_PRICE_CEILING=0.15
      - LONGSHOT_MIN_NET_EDGE=0.04
      - LONGSHOT_FEE_CURVE_BASE_RATE=0.02
    dns:
      - 8.8.8.8
    depends_on:
      arb-builder:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    volumes:
      - ../apps/arb-scanner:/usr/src/app
      - arb_target:/usr/src/app/target
    command: ./target/debug/arb-scanner
    restart: unless-stopped
    mem_limit: 256m

volumes:
  postgres_data:
  redis_data:
  arb_target:
